name: Deploy to Development

concurrency:
  group: terraform-dev-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - develop


env:
  PROJECT_ID: streamquest-472309
  REGION: europe-west1
  REPO_ID: orders

jobs:
  deploy-dev:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0

    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.DEV_GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Export ADC for Terraform
      run: echo "GOOGLE_APPLICATION_CREDENTIALS=${{ steps.auth.outputs.credentials_file_path }}" >> $GITHUB_ENV

    - name: Create Terraform state bucket if not exists
      run: |
        gsutil ls -b gs://streamquest-472309-terraform-states >/dev/null 2>&1 \
          || gsutil mb -p ${PROJECT_ID} -l ${REGION} -b on gs://streamquest-472309-terraform-states \
          || true

    - name: Terraform Init
      run: |
        terraform init -reconfigure -backend-config="bucket=streamquest-472309-terraform-states" -backend-config="prefix=streamquest/dev"
      working-directory: .

    - name: Import existing VPC/subnet if present
      run: |
        set -e
        if gcloud compute networks describe streamquest-vpc-2 --project=${PROJECT_ID} --format="get(name)" >/dev/null 2>&1; then
          terraform import -lock-timeout=5m -input=false -var-file=env/dev.tfvars \
            module.vpc_network.google_compute_network.vpc \
            projects/${PROJECT_ID}/global/networks/streamquest-vpc-2 || true
        fi

        if gcloud compute networks subnets describe streamquest-vpc-2-subnet --region=${REGION} --project=${PROJECT_ID} --format="get(name)" >/dev/null 2>&1; then
          terraform import -lock-timeout=5m -input=false -var-file=env/dev.tfvars \
            module.vpc_network.google_compute_subnetwork.subnet \
            projects/${PROJECT_ID}/regions/${REGION}/subnetworks/streamquest-vpc-2-subnet || true
        fi

        terraform import -lock-timeout=5m -input=false -var-file=env/dev.tfvars \
          module.vpc_network.google_compute_global_address.psa_range \
          projects/${PROJECT_ID}/global/addresses/streamquest-vpc-2-psa || true

        terraform import -lock-timeout=5m -input=false -var-file=env/dev.tfvars \
          module.vpc_network.google_service_networking_connection.private_vpc_connection \
          services/servicenetworking.googleapis.com:projects/${PROJECT_ID}/global/networks/streamquest-vpc-2 || true

        terraform import -lock-timeout=5m -input=false -var-file=env/dev.tfvars \
          module.vpc_network.google_service_networking_connection.private_vpc_connection \
          projects/${PROJECT_ID}/global/networks/streamquest-vpc-2 || true
      working-directory: .

    - name: Terraform Plan
      run: |
        terraform plan -lock-timeout=5m -var-file=env/dev.tfvars
      working-directory: .

    - name: Terraform Apply
      run: |
        terraform apply -lock-timeout=5m -auto-approve -var-file=env/dev.tfvars
      working-directory: .

    - name: Terraform Destroy on failure
      if: ${{ failure() }}
      run: |
        terraform init -reconfigure -backend-config="bucket=streamquest-472309-terraform-states" -backend-config="prefix=streamquest/dev" -lock-timeout=5m
        terraform destroy -lock-timeout=5m -auto-approve -input=false -var-file=env/dev.tfvars
      working-directory: .
